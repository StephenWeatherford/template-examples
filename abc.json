{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters2": {
        "projectName": {
            "type": "string",
            "defaultValue": "rds",
            "metadata": {
                "description": "Define the project name or prefix for all objects."
            }
        },
        "DNSEntry": {
            "type": "string",
            "defaultValue": "remoteapps",
            "metadata": {
                "description": "The name for web access and gateway."
            }
        },
        "DNSZone": {
            "type": "string",
            "defaultValue": "contoso.com",
            "metadata": {
                "description": "External DNS domain zone."
            }
        },
        "vmNames": {
            "type": "array",
            "defaultValue": [
                "[concat(parameters('projectName'),'dc')]",
                "[concat(parameters('projectName'),'wg')]",
                "[concat(parameters('projectName'),'cb')]",
                "[concat(parameters('projectName'),'sh')]",
                "[concat(parameters('projectName'),'lf')]"
            ],
            "metadata": {
                "description": "This adds the projectName plus suffix for VMs."
            }
        },
        "dcCount": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "How many Domain Controllers would you like to deploy?"
            }
        },
        "rdcbCount": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "How many RD Connection Brokers would you like to deploy?"
            }
        },
        "rdwgCount": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "How many RD Web Access/Gateways would you like to deploy?"
            }
        },
        "rdshCount": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "How many RD Session Hosts would you like to deploy?"
            }
        },
        "lsfsCount": {
            "type": "int",
            "defaultValue": 2,
            "metadata": {
                "description": "How many License/File Servers would you like to deploy?"
            }
        },
        "vmProperties": {
            "type": "array",
            "defaultValue": [
                { // Domain Controller VMs
                    "name": "[parameters('vmNames')[0]]",
                    "count": "[parameters('dcCount')]",
                    "intLbBackEndPool": "",
                    "pubLbBackEndPool": "",
                    "dscFunction": "DeployRDSLab.ps1\\CreateRootDomain"
                },
                { // Remote Desktop Web/Gateway VMs
                    "name": "[parameters('vmNames')[1]]",
                    "count": "[parameters('rdwgCount')]",
                    "intLbBackEndPool": "rds-webgateways-int-pool",
                    "pubLbBackEndPool": "rds-webgateways-pub-pool",
                    "dscFunction": "DeployRDSLab.ps1\\RDWebGateway"
                },
                { // Remote Desktop Connection Broker VMs
                    "name": "[parameters('vmNames')[2]]",
                    "count": "[parameters('rdcbCount')]",
                    "intLbBackEndPool": "rds-brokers-int-pool",
                    "pubLbBackEndPool": "",
                    "dscFunction": "DeployRDSLab.ps1\\RDSDeployment"
                },
                { // Remote Desktop Session Host VMs
                    "name": "[parameters('vmNames')[3]]",
                    "count": "[parameters('rdshCount')]",
                    "intLbBackEndPool": "",
                    "pubLbBackEndPool": "",
                    "dscFunction": "DeployRDSLab.ps1\\RDSessionHost"
                },
                { // License Server/File Server VMs
                    "name": "[parameters('vmNames')[4]]",
                    "count": "[parameters('lsfsCount')]",
                    "intLbBackEndPool": "",
                    "pubLbBackEndPool": "",
                    "dscFunction": "DeployRDSLab.ps1\\RDLicenseServer"
                }
            ],
            "metadata": {
                "description": "These parameters define settings for the VMs. No need to change."
            }
        }
    },
    "resources": [
        { // Multiple deployments, PIPs, NICs, VMs
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat(parameters('vmProperties')[copyIndex()].name,'Deployment')]",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "loopCount": {
                        "value": "[parameters('vmProperties')[copyIndex()].count]"
                    },
                    "p1": {
                        "value": "[concat(parameters('vmProperties')[copyIndex()].name,'Deployment')]"
                    },
                    "p2": {
                         "value": "[parameters('vmProperties')[copyIndex()].count]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "loopCount": {
                            "type": "int"
                        },
                        "p1": {
                            "type": "string"
                        },
                        "p2": {
                            "type": "int"
                        }
                    },
                    "resources": [
                    ]
                }
            },
            "copy": {
                "name": "vmCopy",
                "count": "[length(parameters('vmProperties'))]"
            }
        }
    ]
}